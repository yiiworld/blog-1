<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Cakephp | forecho]]></title>
  <link href="http://blog.forecho.com/categories/cakephp/atom.xml" rel="self"/>
  <link href="http://blog.forecho.com/"/>
  <updated>2016-07-08T02:14:06+00:00</updated>
  <id>http://blog.forecho.com/</id>
  <author>
    <name><![CDATA[forecho]]></name>
    <email><![CDATA[caizhenghai@gmail.com]]></email>
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[CakePHP 使用小技巧]]></title>
    <link href="http://blog.forecho.com/about-cakephp-tips.html"/>
    <updated>2014-11-19T14:00:01+00:00</updated>
    <id>http://blog.forecho.com/about-cakephp-tips</id>
    <content type="html"><![CDATA[<ul id="markdown-toc">
  <li><a href="#id-" id="markdown-toc-id-">知道主键 ID 更新一条数据，代码示例：</a></li>
  <li><a href="#section" id="markdown-toc-section">点赞的时候需要+1，如何更新数据库？</a></li>
  <li><a href="#section-1" id="markdown-toc-section-1">如何通过主键最简单的方式获取到一条数据？</a></li>
  <li><a href="#cakephp" id="markdown-toc-cakephp">CakePHP控制器如何返回上一页？</a></li>
  <li><a href="#cakephp-ab" id="markdown-toc-cakephp-ab">CakePHP A控制器调用B控制器？</a></li>
  <li><a href="#sql-" id="markdown-toc-sql-">输出单个页面执行的 SQL 语句</a></li>
  <li><a href="#or-" id="markdown-toc-or-">模糊和 OR 搜索示例：</a></li>
  <li><a href="#find--" id="markdown-toc-find--">find 的 语法糖</a></li>
  <li><a href="#findbyfieldnamestring-value-mixed-fields-mixed-order" id="markdown-toc-findbyfieldnamestring-value-mixed-fields-mixed-order">findBy<fieldName>(string $value[, mixed $fields[, mixed $order]]);</fieldName></a>    <ul>
      <li><a href="#cakephp-saveall-" id="markdown-toc-cakephp-saveall-">CakePHP saveAll 的用法:</a></li>
      <li><a href="#cakephp--html--form" id="markdown-toc-cakephp--html--form">如果要是有 CakePHP 自带和 HTML 结合的 FORM</a></li>
      <li><a href="#cakephp-" id="markdown-toc-cakephp-">CakePHP 中表有以下字段名，则自动更新时间</a></li>
      <li><a href="#cakephp--1" id="markdown-toc-cakephp--1">CakePHP 自带图片+链接</a></li>
      <li><a href="#cakephp--2" id="markdown-toc-cakephp--2">CakePHP 查询的时候表联接</a></li>
      <li><a href="#cakephp--3" id="markdown-toc-cakephp--3">CakePHP 获取当前域名</a></li>
      <li><a href="#cakephp--4" id="markdown-toc-cakephp--4">CakePHP 控制器构造函数的用法：</a></li>
      <li><a href="#cakephp--url-" id="markdown-toc-cakephp--url-">CakePHP 视图获取 URL 的参数值</a></li>
      <li><a href="#cakephp--5" id="markdown-toc-cakephp--5">CakePHP 联表分页</a></li>
      <li><a href="#cakephp--6" id="markdown-toc-cakephp--6">CakePHP 抛出异常</a></li>
      <li><a href="#cakephp--7" id="markdown-toc-cakephp--7">CakePHP 跳转链接</a></li>
      <li><a href="#cakephp-model-" id="markdown-toc-cakephp-model-">CakePHP Model 使用其他模型</a></li>
    </ul>
  </li>
</ul>

<h3 id="id-">知道主键 ID 更新一条数据，代码示例：</h3>

<p><code>php
$this-&gt;Order-&gt;id = $id;
$this-&gt;Order-&gt;saveField('status', $status);
</code></p>

<h3 id="section">点赞的时候需要+1，如何更新数据库？</h3>

<p><code>php
$this-&gt;Widget-&gt;updateAll(
    array('Widget.numberfield' =&gt; 'Widget.numberfield + 1'),
    array('Widget.id' =&gt; 1)
);
</code></p>

<h3 id="section-1">如何通过主键最简单的方式获取到一条数据？</h3>

<p><code>php
// 只获取name字段信息
$this-&gt;User-&gt;read('name', $id);
// 获取所有信息
$this-&gt;User-&gt;read(null, $id);
</code></p>

<!--more-->

<h3 id="cakephp">CakePHP控制器如何返回上一页？</h3>

<p><code>php
$this-&gt;redirect($this-&gt;referer());
</code></p>

<h3 id="cakephp-ab">CakePHP A控制器调用B控制器？</h3>

<p><code>php
$this-&gt;requestAction(
    array('controller'=&gt;'Wx','action'=&gt;'aa'),
    array('data'=&gt;
        array('xing'=&gt;'A1','ming'=&gt;'A2')
    )
);
</code></p>

<p>这样可以在A控制器调用B控制器方法，而且在后面传参过去，用$this-&gt;request-&gt;data获取参数值。</p>

<h3 id="sql-">输出单个页面执行的 SQL 语句</h3>

<p><code>php
$log = $this-&gt;Model-&gt;getDataSource()-&gt;getLog(false, false);
debug($log);
</code></p>

<p>Model要改一下名字才能用。</p>

<h3 id="or-">模糊和 OR 搜索示例：</h3>

<p><code>php
$this-&gt;User-&gt;find('all', array(
   'conditions' =&gt; array(
   		'OR' =&gt;array(
			array('nickname like ' =&gt; "%$keyword%"),
			array('User.id' =&gt; $keyword),
		)
	),
	'fields' =&gt; 'User.id,User.nickname'
));
</code></p>

<h3 id="find--">find 的 语法糖</h3>

<p>&#8220;`php
#findAllBy<fieldName>(string $value, array $fields, array $order, int $limit, int $page, int $recursive)
$this-&gt;Product-&gt;findAllByOrderStatus(&#8216;3&#8217;);
$this-&gt;User-&gt;findAllByUsernameAndPassword(&#8216;jhon&#8217;, &#8216;123&#8217;);
$this-&gt;User-&gt;findAllByEmailOrUsername(&#8216;jhon&#8217;, &#8216;jhon&#8217;);
$this-&gt;User-&gt;findAllByLastName(&#8216;psychic&#8217;, array(),array(&#8216;User.user_name&#8217; =&gt; &#8216;asc&#8217;));</fieldName></p>

<h1 id="findbyfieldnamestring-value-mixed-fields-mixed-order">findBy<fieldName>(string $value[, mixed $fields[, mixed $order]]);</fieldName></h1>
<p>$this-&gt;Recipe-&gt;findByType(‘Cookie’);
$this-&gt;User-&gt;findByEmailOrUsername(‘jhon’,’jhon’);
$this-&gt;User-&gt;findByUsernameAndPassword(‘jhon’,’123’);
&#8220;`</p>

<h3 id="cakephp-saveall-">CakePHP saveAll 的用法:</h3>

<p><code>php
for ($i=0; $i &lt; count($data['product_id']); $i++) {
	$item[$i]['DiscountProduct']['discount_id'] = $this-&gt;Discount-&gt;id;
	$item[$i]['DiscountProduct']['discount'] = $data['discount'][$i];
}
$this-&gt;DiscountProduct-&gt;saveAll($item);
</code></p>

<h3 id="cakephp--html--form">如果要是有 CakePHP 自带和 HTML 结合的 FORM</h3>
<p>必须在 Controller 的 action 里面使用这个：<code>$this-&gt;request-&gt;data = $data;</code> 修改的时候才能读取数据，并且view里面的 form 要使用 CakePHP 的</p>

<p><code>php
&lt;?php echo $this-&gt;Form-&gt;create('PrintAd', array('type'=&gt;'post')); ?&gt;
</code></p>

<h3 id="cakephp-">CakePHP 中表有以下字段名，则自动更新时间</h3>

<p><code>sql
`created` datetime NOT NULL,
`modified` datetime NOT NULL,
</code></p>

<h3 id="cakephp--1">CakePHP 自带图片+链接</h3>

<p><code>php
echo $this-&gt;Html-&gt;link(
     $this-&gt;Html-&gt;image($value['PrintClient']['weixin_code_img'], array('width'=&gt;'60px')),
     $value['PrintClient']['weixin_code_img'],
     array('escape' =&gt; false)
);
</code></p>

<h3 id="cakephp--2">CakePHP 查询的时候表联接</h3>

<p><code>php
$options['joins'] = array(
	array(
		'table' =&gt; 'channels',
		'alias' =&gt; 'Channel',
		'type' =&gt; 'LEFT',
		'conditions' =&gt; array(
			'Channel.id = Item.channel_id',
		)
	));
$Item-&gt;find('all', $options);
</code></p>

<h3 id="cakephp--3">CakePHP 获取当前域名</h3>

<p><code>php
Router::fullbaseUrl()
</code></p>

<h3 id="cakephp--4">CakePHP 控制器构造函数的用法：</h3>

<p><code>php
public function__construct($request = null, $response = null)
{
	parent::__construct($request, $response);
	# code...
}
</code></p>

<h3 id="cakephp--url-">CakePHP 视图获取 URL 的参数值</h3>

<p><code>php
#array():
$this-&gt;params-&gt;pass
#第一个值：
$this-&gt;params-&gt;pass[0]
</code></p>

<h3 id="cakephp--5">CakePHP 联表分页</h3>

<p><code>php
$this-&gt;loadModel('WifiList');
$this-&gt;SearchPagination-&gt;setup('WifiList');
$this-&gt;request-&gt;data['WifiList']['seller_id'] = SELLER_ID;
$this-&gt;paginate = array(
	'fields' =&gt; array('WifiList.*', 'WxPersistentQrcodes.ticket'),
	'conditions' =&gt; $this-&gt;WifiList-&gt;parseCriteria($this-&gt;request-&gt;data['WifiList']),
	'order' =&gt; 'WifiList.id desc',
	'joins' =&gt; array(
		array(
			'table'=&gt;'wx_persistent_qrcodes',
			'alias'=&gt;'WxPersistentQrcodes',
			'type'=&gt;'LEFT',
			'conditions'=&gt;array(
				'WifiList.wx_p_qrcode_id=WxPersistentQrcodes.scene_id and WxPersistentQrcodes.seller_id='.SELLER_ID
			)
		)
	),
	'limit' =&gt; 10
);
$data = $this-&gt;paginate('WifiList');
$this-&gt;set(compact('data'));
</code></p>

<h3 id="cakephp--6">CakePHP 抛出异常</h3>

<p><code>php
if(!$id){
	throw new NotFoundException();
}
</code></p>

<h3 id="cakephp--7">CakePHP 跳转链接</h3>

<p><code>php
$this-&gt;redirect(array(
	'controller'=&gt;'dist',
	'action'=&gt;'result',
	$status,
	'?'=&gt;array('sid'=&gt;SELLER_ID,)
));
</code></p>

<h3 id="cakephp-model-">CakePHP Model 使用其他模型</h3>

<p>&#8220;`php
// the other model to load &amp; use
App::uses(‘AnotherModel’, ‘Model’);
class MyModel extends AppModel {
	public $name = ‘MyModel’;</p>

<pre><code>public function test() {
	// load the Model
	$anotherModel = new AnotherModel();
	// use the Model
	$anotherModel-&gt;save($data);
} } ```
</code></pre>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[CakePHP 使用插件导出 CSV 文件]]></title>
    <link href="http://blog.forecho.com/cakephp-shi-yong-cha-jian-dao-chu-csv-wen-jian.html"/>
    <updated>2014-09-05T13:42:01+00:00</updated>
    <id>http://blog.forecho.com/cakephp-shi-yong-cha-jian-dao-chu-csv-wen-jian</id>
    <content type="html"><![CDATA[<p>插件地址：<a href="https://github.com/josegonzalez/cakephp-csvview">https://github.com/josegonzalez/cakephp-csvview</a></p>

<p>用法就不说了，上面写的很详细了，补充两点吧。</p>

<p><strong>1. 是数字显示的问题</strong></p>

<p>有时候数字很大，导出的文件打开，数字变成科学计数法显示了，这显然不是我们想要的，手动在每个值后面添加一个制表符「\t」就解决这个问题了。代码如下：</p>

<p><code>php
foreach ($data as $key =&gt; $value) {
    $item[$key]['username'] = $value['username']. "\t";
    $item[$key]['mobile']   = $value['mobile'] . "\t";
    $item[$key]['created']  = $value['created'] . "\t";
}
</code>
<!--more-->
<strong>2. 导出文件 office 中文乱码</strong></p>

<p>Plugin/CsvView/View/CsvView.php 文件的 _renderRow 函数，大概在 251 行之后添加如下代码解决中文乱码：</p>

<p><code>php
if ($row) {
    foreach ($rowas$key =&gt; $value) {
        $row[$key] = iconv('utf-8','gb2312',$value);
    }
}
</code></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[CakePHP Ajax分页]]></title>
    <link href="http://blog.forecho.com/CakePHP-ajax-fen-ye.html"/>
    <updated>2014-01-23T16:09:00+00:00</updated>
    <id>http://blog.forecho.com/CakePHP-ajax-fen-ye</id>
    <content type="html"><![CDATA[<p>Controller文件头部调用CakePHP自带分页并且配置分页条数代码：</p>

<pre><code>public $components = array('RequestHandler', 'Paginator');
public $paginate = array('limit' =&gt; 2 );  //2是为了方便测试
</code></pre>

<p>调用的action方法如下：</p>

<pre><code>public function list()
{
    $this-&gt;Paginator-&gt;settings = $this-&gt;paginate;
    $data = $this-&gt;Paginator-&gt;paginate('Notice');
    $this-&gt;set('data', $data);
}
</code></pre>

<p>list.ctp文件，代码如下：</p>

<pre><code>&lt;?php echo $this-&gt;Js-&gt;writeBuffer(array('inline'=&gt;false));?&gt;
&lt;div id="search_result"&gt;
    &lt;?php foreach ($data as $key =&gt; $value): ?&gt;
        &lt;?php echo $value['Notice']['title'] ?&gt;
    &lt;?php endforeach ?&gt;
    &lt;?php $this-&gt;Paginator-&gt;options(array(
                'update' =&gt; '#search_result',
                'evalScripts' =&gt; true,
    ));?&gt;
    &lt;?php echo $this-&gt;Paginator-&gt;prev('上一页' . __('', true), array(), null, array('class'=&gt;'disabled'));?&gt;
    &lt;?php echo $this-&gt;Paginator-&gt;numbers(array('class' =&gt; 'numbers', 'first' =&gt; false, 'last' =&gt; false));?&gt;
    &lt;?php echo $this-&gt;Paginator-&gt;next(__('下一页', true) . ' &gt;&gt;', array(), null, array('class' =&gt; 'disabled'));?&gt;
    &lt;?php echo $this-&gt;Js-&gt;writeBuffer(array('inline'=&gt;true));?&gt;
&lt;/div&gt;
</code></pre>

<p>参考文章： <a href="http://endoyuta.com/2013/05/06/cakephp-2-3-ajax%E3%81%AApagination/">http://endoyuta.com/2013/05/06/cakephp-2-3-ajax%E3%81%AApagination/</a> <a href="http://caky.de/en/core-libraries/helpers/js.html#ajax-pagination">http://caky.de/en/core-libraries/helpers/js.html#ajax-pagination</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[CakePHP的小技巧用法]]></title>
    <link href="http://blog.forecho.com/CakePHP-de-xiao-ji-qiao-yong-fa.html"/>
    <updated>2014-01-03T11:25:00+00:00</updated>
    <id>http://blog.forecho.com/CakePHP-de-xiao-ji-qiao-yong-fa</id>
    <content type="html"><![CDATA[<p><strong>1、问：如果控制器有一个方法，不要视图怎么办？</strong></p>

<p>答：使用：$this-&gt;autoRender = false</p>

<p><strong>2、对于一直在开发的网站，在频繁更新的情况下，如何保证css文件、js文件和image文件不调用浏览器缓存文件问题？</strong></p>

<p>答：一个是在调用的文件名最后加变量后缀，如时间。示例代码如下：</p>

<pre><code>&lt;link rel="stylesheet" type="text/css" href="http://forecho.com/css/index.css?2014-01-03-1" media="all" /&gt;
</code></pre>

<p>二如果是CakePHP的话还可以修改core.php配置文件，代码如下：</p>

<pre><code>/**
 * Apply timestamps with the last modified time to static assets (js, css, images).
 * Will append a querystring parameter containing the time the file was modified. This is
 * useful for invalidating browser caches.
 *
 * Set to `true` to apply timestamps when debug &gt; 0. Set to 'force' to always enable
 * timestamping regardless of debug value.
 */
    Configure::write('Asset.timestamp', true);
</code></pre>

<p>这样的好处是你接下来可以直接用CakePHP自带的写法调用图片和文件了，如：</p>

<pre><code>&lt;?php
	echo $this-&gt;Html-&gt;css('main');
	echo $this-&gt;Html-&gt;image();
?&gt;
</code></pre>

<p><strong>3、点赞的时候需要+1，如何更新数据库？</strong></p>

<p>代码如下：</p>

<pre><code>$this-&gt;Widget-&gt;updateAll(
    array('Widget.numberfield' =&gt; 'Widget.numberfield + 1'),
    array('Widget.id' =&gt; 1)
);
</code></pre>

<p><strong>4、如何通过主键最简单的方式获取到一条数据？</strong></p>

<p>代码如下：</p>

<pre><code>// 只获取name字段信息
$this-&gt;User-&gt;read("name", $id);
// 获取所有信息
$this-&gt;User-&gt;read(null, $id);
</code></pre>

<p><strong>5、CakePHP控制器如何返回上一页？</strong></p>

<pre><code>$this-&gt;redirect($this-&gt;referer());
</code></pre>

<p><strong>6、CakePHP A控制器调用B控制器</strong></p>

<pre><code>$this-&gt;requestAction(
    array('controller'=&gt;'Wx','action'=&gt;'aa'),
    array('data'=&gt;
        array('xing'=&gt;'A1','ming'=&gt;'A2')
    )
);
</code></pre>

<p>这样可以在A控制器调用B控制器方法，而且在后面传参过去，用$this-&gt;request-&gt;data获取参数值。</p>

<p><strong>7、输出单个页面执行的SQL语句</strong></p>

<pre><code>$log = $this-&gt;Model-&gt;getDataSource()-&gt;getLog(false, false);
debug($log);
</code></pre>

<p>Model要改一下名字才能用。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[CakePHP belongsTo不是主键关联]]></title>
    <link href="http://blog.forecho.com/CakePHP-belongsTo-bu-shi-zhu-jian-guan-lian.html"/>
    <updated>2014-01-02T17:06:00+00:00</updated>
    <id>http://blog.forecho.com/CakePHP-belongsTo-bu-shi-zhu-jian-guan-lian</id>
    <content type="html"><![CDATA[<p>belongsTo是<code>属于</code>的关系。</p>

<pre><code>var $belongsTo = array(

    'Inventory' =&gt; array(
        'className'    =&gt; 'Inventory',
        'foreignKey' =&gt; false,
        'conditions' =&gt; array(' `RentalLineitem`.`i_num` = `Inventory`.`i_num`'),
        'dependent'    =&gt; false //是否级联删除
    )

);
</code></pre>

<p>参考文章：<a href="http://stackoverflow.com/questions/6267804/cakephp-mapping-belongsto-association-to-a-non-primary-key">http://stackoverflow.com/questions/6267804/cakephp-mapping-belongsto-association-to-a-non-primary-key</a></p>
]]></content>
  </entry>
  
</feed>
